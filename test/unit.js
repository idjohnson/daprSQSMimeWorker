const chai = require('chai'), chaiHttp = require('chai-http');
const expect = chai.expect;
chai.use(chaiHttp);
var app = require('../app');

it('succeeds silently!', function(done) {   // <= No done callback
//chai.request('http://localhost:8080')
  this.timeout(500);
  setTimeout(done, 300);
chai.request(app)
  .post('/mysqsforsns')
  .send({
    "Type": "Notification",
    "MessageId": "515bb540-cadd-5b82-8ff4-ec111d6c645d",
    "TopicArn": "arn:aws:sns:us-east-1:095928337644:processemails",
    "Subject": "Amazon SES Email Receipt Notification",
    "Message": "{\"notificationType\":\"Received\",\"mail\":{\"timestamp\":\"2021-06-27T01:33:36.284Z\",\"source\":\"isaac.johnson@gmail.com\",\"messageId\":\"7is22brkhnj34c37bsduqqq6eiat65u5dep207g1\",\"destination\":[\"feedback@talkaboutthe.website\"],\"headersTruncated\":false,\"headers\":[{\"name\":\"Return-Path\",\"value\":\"<isaac.johnson@gmail.com>\"},{\"name\":\"Received\",\"value\":\"from mail-pg1-f171.google.com (mail-pg1-f171.google.com [209.85.215.171]) by inbound-smtp.us-east-1.amazonaws.com with SMTP id 7is22brkhnj34c37bsduqqq6eiat65u5dep207g1 for feedback@talkaboutthe.website; Sun, 27 Jun 2021 01:33:36 +0000 (UTC)\"},{\"name\":\"X-SES-Spam-Verdict\",\"value\":\"PASS\"},{\"name\":\"X-SES-Virus-Verdict\",\"value\":\"PASS\"},{\"name\":\"Received-SPF\",\"value\":\"pass (spfCheck: domain of _spf.google.com designates 209.85.215.171 as permitted sender) client-ip=209.85.215.171; envelope-from=isaac.johnson@gmail.com; helo=mail-pg1-f171.google.com;\"},{\"name\":\"Authentication-Results\",\"value\":\"amazonses.com; spf=pass (spfCheck: domain of _spf.google.com designates 209.85.215.171 as permitted sender) client-ip=209.85.215.171; envelope-from=isaac.johnson@gmail.com; helo=mail-pg1-f171.google.com; dkim=pass header.i=@gmail.com; dmarc=pass header.from=gmail.com;\"},{\"name\":\"X-SES-RECEIPT\",\"value\":\"AEFBQUFBQUFBQUFHbFJHUTY4L2NFK1Fib080VzdKUmtkd3M4TVdWMVE0UlJVaFg5LzZLNGNrZklndDBNS3hoZzgxbTFhWEJLRWJDZkp3THFmei9WSjZaNTBTUkdkblBUMHJFbWN6ZzQ3TzVtTm96akJHb2tMRE5TMDJNQ3FVc3hSQnl0VU5uWDJxc2VxcnZaVWVvbEExS3hQd1FoQTZ1TFJXcmIraDBJLytqV0I2b21FWkpBSS9FVzAwVVVQWXlnU3FHc0wzRERNQVI5bTRiamY0TEV3dEVWU1BZNXgvazhhV0xHOFpRQUVoQi9WQ2ZIelk0OHlSR1lCbjJQTk4zOFdQbk9pMnI4enl5T3VxTVozMVVhRysya0tsRkxiaW5GQkQxYmRxR0VtU2ROaDRiNjMyWmcySEE9PQ==\"},{\"name\":\"X-SES-DKIM-SIGNATURE\",\"value\":\"a=rsa-sha256; q=dns/txt; b=VoQ4Sjd5ehctm8a4cULRtxAae2F03B+2U+poE4B83zJiBYlfO51iafPANd3w1hY42BZAp4cIyZ+iTLuWRAs/X+MbHU7gA76GcCqyCyEtj7ddFGetrQeY+Uk4DXCg9Bhc7oObzuf77+hPd+4I3TmBQ5gwy8kUI/jU0JdaBoezcrc=; c=relaxed/simple; s=ug7nbtf4gccmlpwj322ax3p6ow6yfsug; d=amazonses.com; t=1624757616; v=1; bh=wmnnvd0keVK3bmW0RNqP82ZxYPJddie+MzSJrKyrS8Y=; h=From:To:Cc:Bcc:Subject:Date:Message-ID:MIME-Version:Content-Type:X-SES-RECEIPT;\"},{\"name\":\"Received\",\"value\":\"by mail-pg1-f171.google.com with SMTP id u190so11962696pgd.8 for <feedback@talkaboutthe.website>; Sat, 26 Jun 2021 18:33:36 -0700 (PDT)\"},{\"name\":\"DKIM-Signature\",\"value\":\"v=1; a=rsa-sha256; c=relaxed/relaxed; d=gmail.com; s=20161025; h=mime-version:from:date:message-id:subject:to; bh=wmnnvd0keVK3bmW0RNqP82ZxYPJddie+MzSJrKyrS8Y=; b=eJhq6DNjAV5JsRjrCBoc48t06DSkNuT+YCkt3tDdW6zn81eoKj5KFfWzyQzaqV6ImxEHq95j0iz402HWrYHtOxLTp/KtYXMtvPumqBgzZlcO70Dif8ffOkegzwpZqT8Twyz1H/R4zvt2M39Ahff4XiBx7kXXqYN9RaaoUmZQbnidXKizMSU2A8lXKmg6CzSKSy0IqRrOyB/tgvTHDlTv5XcqkpKS9YjjXRW7KapgJSLJqtIqx/oKYNrE8uklJqDAGt6OgTb3aFDLiWjPDF47ift1f3GgZzmX0zpoNGSj6RMkUISIvSAljCKXhZpa1sBF3uGdfor1TU0Ggj7agZEKsg==\"},{\"name\":\"X-Google-DKIM-Signature\",\"value\":\"v=1; a=rsa-sha256; c=relaxed/relaxed; d=1e100.net; s=20161025; h=x-gm-message-state:mime-version:from:date:message-id:subject:to; bh=wmnnvd0keVK3bmW0RNqP82ZxYPJddie+MzSJrKyrS8Y=; b=n7+A6cfg/OjySr3S+Jeyjex+GyJihT2oBtyNt3sDF+VXgaKtyCamey8Dme1E4lpG+S 4aRWLWTwZXDxqDKqJ4XbrqePju6jA2/pffdqoqjF8XcjUBFOYHcxQuFVXudpMh8L7ZWb xr+f5M8mQGaNxZ5VTM7oULioQ+oVs4VrDpII4wkbBsMpSYuUryVB2ckjP1SB06AsLGZK LisR/0uilkASyVqdB+UE0NnMMhXAwRm48kKsgANPhJP2ItUPN0HmJ3/2J/8xO4ttGa+z pHDxJ9Qy+++MF272DDpqDd4WXd7Pf12ypmSPpbPLolqRsuzIEM+jFq1THE05K4y0dWX5 1WZg==\"},{\"name\":\"X-Gm-Message-State\",\"value\":\"AOAM53150knz4cWlxGsb2dGcaSt71hL9/nOlQwPauqdgma4ZMfC4n0X1 S0RhxxXdpxn2pL+1UlrA+Q+Ii0WbMN2UOkdIEgCe5/byaymMkw==\"},{\"name\":\"X-Google-Smtp-Source\",\"value\":\"ABdhPJyYZd20SLQQKn2lBbfKf+qXvxgHZhIzMRpa6uG2Ruc7KnOz9+IKfcQV/30S4FhTPwwQvXjoiGyPMfBueDwy2dg=\"},{\"name\":\"X-Received\",\"value\":\"by 2002:a62:2ec7:0:b029:301:fe50:7d4b with SMTP id u190-20020a622ec70000b0290301fe507d4bmr17917606pfu.78.1624757614929; Sat, 26 Jun 2021 18:33:34 -0700 (PDT)\"},{\"name\":\"MIME-Version\",\"value\":\"1.0\"},{\"name\":\"From\",\"value\":\"Isaac Johnson <isaac.johnson@gmail.com>\"},{\"name\":\"Date\",\"value\":\"Sat, 26 Jun 2021 20:33:23 -0500\"},{\"name\":\"Message-ID\",\"value\":\"<CAEccrgWN3mmDFyn_7WrJTDTpwLaH0YYOBtnm7kVz6nK4B_E0OA@mail.gmail.com>\"},{\"name\":\"Subject\",\"value\":\"testing 1234\"},{\"name\":\"To\",\"value\":\"feedback@talkaboutthe.website\"},{\"name\":\"Content-Type\",\"value\":\"multipart/alternative; boundary=\\\"0000000000007bec9d05c5b55cea\\\"\"}],\"commonHeaders\":{\"returnPath\":\"isaac.johnson@gmail.com\",\"from\":[\"Isaac Johnson <isaac.johnson@gmail.com>\"],\"date\":\"Sat, 26 Jun 2021 20:33:23 -0500\",\"to\":[\"feedback@talkaboutthe.website\"],\"messageId\":\"<CAEccrgWN3mmDFyn_7WrJTDTpwLaH0YYOBtnm7kVz6nK4B_E0OA@mail.gmail.com>\",\"subject\":\"testing 1234\"}},\"receipt\":{\"timestamp\":\"2021-06-27T01:33:36.284Z\",\"processingTimeMillis\":710,\"recipients\":[\"feedback@talkaboutthe.website\"],\"spamVerdict\":{\"status\":\"PASS\"},\"virusVerdict\":{\"status\":\"PASS\"},\"spfVerdict\":{\"status\":\"PASS\"},\"dkimVerdict\":{\"status\":\"PASS\"},\"dmarcVerdict\":{\"status\":\"PASS\"},\"action\":{\"type\":\"SNS\",\"topicArn\":\"arn:aws:sns:us-east-1:095928337644:processemails\",\"encoding\":\"UTF8\"}},\"content\":\"Return-Path: <isaac.johnson@gmail.com>\\r\\nReceived: from mail-pg1-f171.google.com (mail-pg1-f171.google.com [209.85.215.171])\\r\\n by inbound-smtp.us-east-1.amazonaws.com with SMTP id 7is22brkhnj34c37bsduqqq6eiat65u5dep207g1\\r\\n for feedback@talkaboutthe.website;\\r\\n Sun, 27 Jun 2021 01:33:36 +0000 (UTC)\\r\\nX-SES-Spam-Verdict: PASS\\r\\nX-SES-Virus-Verdict: PASS\\r\\nReceived-SPF: pass (spfCheck: domain of _spf.google.com designates 209.85.215.171 as permitted sender) client-ip=209.85.215.171; envelope-from=isaac.johnson@gmail.com; helo=mail-pg1-f171.google.com;\\r\\nAuthentication-Results: amazonses.com;\\r\\n spf=pass (spfCheck: domain of _spf.google.com designates 209.85.215.171 as permitted sender) client-ip=209.85.215.171; envelope-from=isaac.johnson@gmail.com; helo=mail-pg1-f171.google.com;\\r\\n dkim=pass header.i=@gmail.com;\\r\\n dmarc=pass header.from=gmail.com;\\r\\nX-SES-RECEIPT: AEFBQUFBQUFBQUFHbFJHUTY4L2NFK1Fib080VzdKUmtkd3M4TVdWMVE0UlJVaFg5LzZLNGNrZklndDBNS3hoZzgxbTFhWEJLRWJDZkp3THFmei9WSjZaNTBTUkdkblBUMHJFbWN6ZzQ3TzVtTm96akJHb2tMRE5TMDJNQ3FVc3hSQnl0VU5uWDJxc2VxcnZaVWVvbEExS3hQd1FoQTZ1TFJXcmIraDBJLytqV0I2b21FWkpBSS9FVzAwVVVQWXlnU3FHc0wzRERNQVI5bTRiamY0TEV3dEVWU1BZNXgvazhhV0xHOFpRQUVoQi9WQ2ZIelk0OHlSR1lCbjJQTk4zOFdQbk9pMnI4enl5T3VxTVozMVVhRysya0tsRkxiaW5GQkQxYmRxR0VtU2ROaDRiNjMyWmcySEE9PQ==\\r\\nX-SES-DKIM-SIGNATURE: a=rsa-sha256; q=dns/txt; b=VoQ4Sjd5ehctm8a4cULRtxAae2F03B+2U+poE4B83zJiBYlfO51iafPANd3w1hY42BZAp4cIyZ+iTLuWRAs/X+MbHU7gA76GcCqyCyEtj7ddFGetrQeY+Uk4DXCg9Bhc7oObzuf77+hPd+4I3TmBQ5gwy8kUI/jU0JdaBoezcrc=; c=relaxed/simple; s=ug7nbtf4gccmlpwj322ax3p6ow6yfsug; d=amazonses.com; t=1624757616; v=1; bh=wmnnvd0keVK3bmW0RNqP82ZxYPJddie+MzSJrKyrS8Y=; h=From:To:Cc:Bcc:Subject:Date:Message-ID:MIME-Version:Content-Type:X-SES-RECEIPT;\\r\\nReceived: by mail-pg1-f171.google.com with SMTP id u190so11962696pgd.8\\r\\n        for <feedback@talkaboutthe.website>; Sat, 26 Jun 2021 18:33:36 -0700 (PDT)\\r\\nDKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;\\r\\n        d=gmail.com; s=20161025;\\r\\n        h=mime-version:from:date:message-id:subject:to;\\r\\n        bh=wmnnvd0keVK3bmW0RNqP82ZxYPJddie+MzSJrKyrS8Y=;\\r\\n        b=eJhq6DNjAV5JsRjrCBoc48t06DSkNuT+YCkt3tDdW6zn81eoKj5KFfWzyQzaqV6Imx\\r\\n         EHq95j0iz402HWrYHtOxLTp/KtYXMtvPumqBgzZlcO70Dif8ffOkegzwpZqT8Twyz1H/\\r\\n         R4zvt2M39Ahff4XiBx7kXXqYN9RaaoUmZQbnidXKizMSU2A8lXKmg6CzSKSy0IqRrOyB\\r\\n         /tgvTHDlTv5XcqkpKS9YjjXRW7KapgJSLJqtIqx/oKYNrE8uklJqDAGt6OgTb3aFDLiW\\r\\n         jPDF47ift1f3GgZzmX0zpoNGSj6RMkUISIvSAljCKXhZpa1sBF3uGdfor1TU0Ggj7agZ\\r\\n         EKsg==\\r\\nX-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;\\r\\n        d=1e100.net; s=20161025;\\r\\n        h=x-gm-message-state:mime-version:from:date:message-id:subject:to;\\r\\n        bh=wmnnvd0keVK3bmW0RNqP82ZxYPJddie+MzSJrKyrS8Y=;\\r\\n        b=n7+A6cfg/OjySr3S+Jeyjex+GyJihT2oBtyNt3sDF+VXgaKtyCamey8Dme1E4lpG+S\\r\\n         4aRWLWTwZXDxqDKqJ4XbrqePju6jA2/pffdqoqjF8XcjUBFOYHcxQuFVXudpMh8L7ZWb\\r\\n         xr+f5M8mQGaNxZ5VTM7oULioQ+oVs4VrDpII4wkbBsMpSYuUryVB2ckjP1SB06AsLGZK\\r\\n         LisR/0uilkASyVqdB+UE0NnMMhXAwRm48kKsgANPhJP2ItUPN0HmJ3/2J/8xO4ttGa+z\\r\\n         pHDxJ9Qy+++MF272DDpqDd4WXd7Pf12ypmSPpbPLolqRsuzIEM+jFq1THE05K4y0dWX5\\r\\n         1WZg==\\r\\nX-Gm-Message-State: AOAM53150knz4cWlxGsb2dGcaSt71hL9/nOlQwPauqdgma4ZMfC4n0X1\\r\\n\\tS0RhxxXdpxn2pL+1UlrA+Q+Ii0WbMN2UOkdIEgCe5/byaymMkw==\\r\\nX-Google-Smtp-Source: ABdhPJyYZd20SLQQKn2lBbfKf+qXvxgHZhIzMRpa6uG2Ruc7KnOz9+IKfcQV/30S4FhTPwwQvXjoiGyPMfBueDwy2dg=\\r\\nX-Received: by 2002:a62:2ec7:0:b029:301:fe50:7d4b with SMTP id\\r\\n u190-20020a622ec70000b0290301fe507d4bmr17917606pfu.78.1624757614929; Sat, 26\\r\\n Jun 2021 18:33:34 -0700 (PDT)\\r\\nMIME-Version: 1.0\\r\\nFrom: Isaac Johnson <isaac.johnson@gmail.com>\\r\\nDate: Sat, 26 Jun 2021 20:33:23 -0500\\r\\nMessage-ID: <CAEccrgWN3mmDFyn_7WrJTDTpwLaH0YYOBtnm7kVz6nK4B_E0OA@mail.gmail.com>\\r\\nSubject: testing 1234\\r\\nTo: feedback@talkaboutthe.website\\r\\nContent-Type: multipart/alternative; boundary=\\\"0000000000007bec9d05c5b55cea\\\"\\r\\n\\r\\n--0000000000007bec9d05c5b55cea\\r\\nContent-Type: text/plain; charset=\\\"UTF-8\\\"\\r\\n\\r\\ntesting REQ4321\\r\\n\\r\\n--0000000000007bec9d05c5b55cea\\r\\nContent-Type: text/html; charset=\\\"UTF-8\\\"\\r\\n\\r\\n<div dir=\\\"ltr\\\">testing REQ4321</div>\\r\\n\\r\\n--0000000000007bec9d05c5b55cea--\\r\\n\"}",
    "Timestamp": "2021-06-27T01:33:37.012Z",
    "SignatureVersion": "1",
    "Signature": "gnZ3tWeI1PxVjhennxTS6deA4tDBEiL++8faPQEZw/j6sTau0a8mxAMMH1iVPYST3PkTCCZ5+XBPCpnMKWKdJ7pTpcTpoVH5B0h6zT+F1pwzh+giatu3NdcbWCWJSor5UDXRdps6Dcj7ZPqk/5/0EXbRdnKf8f1bUAitjkS3ElvwKCwMCb+bL771BQgRO8p7inJ67yC8GQycWAzPJrLEKhUtgVBxRkKlv/QgDesJVKV/XjwUsjlhcpjKqJzP/p4bDT5tEQz6IiEsxKYvdTH7I+xgDMJR6L1DByVQ8lw0T1Ho1arxARMBVy8Pr/YhqvLkvhYm4D2lJxJlseQhGBmEOw==",
    "SigningCertURL": "https://sns.us-east-1.amazonaws.com/SimpleNotificationService-010a507c1833636cd94bdb98bd93083a.pem",
    "UnsubscribeURL": "https://sns.us-east-1.amazonaws.com/?Action=Unsubscribe&SubscriptionArn=arn:aws:sns:us-east-1:095928337644:processemails:4daca444-d33e-4c12-bd7b-4d31dddd5aa4"
  }).end(function(err, res) {
    expect(res).to.have.status(200);    // <= Test completes before this runs
    app.close();
  }).then(() => app.close());
});
